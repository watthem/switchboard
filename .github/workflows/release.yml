name: Release

on:
  push:
    tags: ["*.*"]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate_tag:
    runs-on: ubuntu-latest
    outputs:
      channel: ${{ steps.parse.outputs.channel }}
    steps:
      - id: parse
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}\.(POC|DEV|BETA|STABLE)$ ]]; then
            echo "Invalid release tag format: $TAG"
            echo "Expected: YYYY-MM-DD.CHANNEL where CHANNEL is POC|DEV|BETA|STABLE"
            exit 1
          fi
          echo "channel=${TAG##*.}" >> "$GITHUB_OUTPUT"

  smoke:
    needs: validate_tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: pip install -e ".[dev]"
      - run: ruff check switchboard/ tests/
      - run: python3 scripts/check_test_quality.py
      - run: pytest tests/ -v --tb=short

  compat_311:
    needs: validate_tag
    if: ${{ needs.validate_tag.outputs.channel != 'POC' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -e ".[dev]"
      - run: pytest tests/ -v --tb=short

  release:
    needs: [validate_tag, smoke, compat_311]
    if: ${{ always() && needs.validate_tag.result == 'success' && needs.smoke.result == 'success' && (needs.compat_311.result == 'success' || needs.compat_311.result == 'skipped') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install build
      - run: python -m build
      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          draft: false
